IF OBJECT_ID('[dbo].[sp_all_particular_get_nameIdPair]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_all_particular_get_nameIdPair]
END
GO
CREATE PROCEDURE [dbo].[sp_all_particular_get_nameIdPair]
AS
BEGIN
    SET NOCOUNT ON;
	SELECT ID AS Id,Name FROM Particular
END
GO
IF OBJECT_ID('[dbo].[sp_all_itemCategory_get_nameIdPair]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_all_itemCategory_get_nameIdPair]
END
GO
CREATE PROCEDURE [dbo].[sp_all_itemCategory_get_nameIdPair]
AS
BEGIN
    SET NOCOUNT ON;
	SELECT ID AS Id,Name FROM ItemCategory
END
GO
IF OBJECT_ID('[dbo].[sp_all_Unit_get_nameIdPair]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_all_Unit_get_nameIdPair]
END
GO
CREATE PROCEDURE [dbo].[sp_all_Unit_get_nameIdPair]
AS
BEGIN
    SET NOCOUNT ON;
	SELECT ID AS Id,UnitName AS Name FROM Unit
END
GO
IF OBJECT_ID('[dbo].[sp_item_create]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_item_create]
END
GO
CREATE PROCEDURE [dbo].[sp_item_create]
	@Name					NVARCHAR(256),	
	@Unit_Id				INT,
	@ItemCode				NVARCHAR(256),
	@ItemCategory_Id		INT,
	@IndicatingUnitPrice	FLOAT,
	@Particular_Id			INT,
	@SystemId				INT,
	@SystemName				NVARCHAR(100),
	@Created_By					INT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @imsCategoryId INT,@imsSubCategoryId INT

	SELECT TOP 1 @imsCategoryId = IMS_CategoryID, @imsSubCategoryId = IMS_SubCategoryID FROM ItemCategory WHERE ID = @ItemCategory_Id

    INSERT INTO [Item]
	    (
		   [Name]
		  ,[Unit_Id]
		  ,[ItemCode]
		  ,[ItemCategory_Id]
		  ,[IndicatingUnitPrice]
		  ,[IMS_CategoryID]
		  ,[IMS_SubCategoryID]
		  ,[System_Id]
		  ,[SystemName]
		  ,[Created_By]
		  ,[Created_Date]
		  ,[Updated_By]
		  ,[Updated_Date]
		  ,[Is_Deleted]
	    )
   VALUES
	    (
		@Name,
		@Unit_Id,
		@ItemCode,
		@ItemCategory_Id,
		@IndicatingUnitPrice,
		@imsCategoryId,
		@imsSubCategoryId,
		@SystemId,
		@SystemName,
		@Created_By,
		GETDATE(),
		@Created_By,
		GETDATE(),
		0
	    )
   SELECT
		SCOPE_IDENTITY() AS [Id]
END
GO
IF OBJECT_ID('[dbo].[sp_item_AMS_create]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_item_AMS_create]
END
GO
CREATE PROCEDURE [dbo].[sp_item_AMS_create]
	@Name					NVARCHAR(256),	
	@Unit_Id				INT,
	@ItemCategory_Id		INT,
	@IndicatingUnitPrice	FLOAT,
	@Particular_Id			INT,
	@SystemName				NVARCHAR(100),
	@Created_By					INT
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @imsCategoryId INT,@imsSubCategoryId INT;
	DECLARE @ItemCode NVARCHAR(100) = '2.01.001.0',@ItemCodeDigit INT;

	SELECT TOP 1 @ItemCodeDigit = CAST(RIGHT(ItemCode,4) AS INT) + 1 FROM Item ORDER BY ItemCode DESC
	BEGIN
	SET @ItemCode = '2.01.001.0'+ CAST(@ItemCodeDigit AS VARCHAR(10))
	END

	SELECT TOP 1 @imsCategoryId = IMS_CategoryID, @imsSubCategoryId = IMS_SubCategoryID FROM ItemCategory WHERE ID = @ItemCategory_Id

    INSERT INTO [Item]
	    (
		   [Name]
		  ,[Unit_Id]
		  ,[ItemCode]
		  ,[ItemCategory_Id]
		  ,[IndicatingUnitPrice]
		  ,[IMS_CategoryID]
		  ,[IMS_SubCategoryID]
		  ,[SystemName]
		  ,[Created_By]
		  ,[Created_Date]
		  ,[Updated_By]
		  ,[Updated_Date]
		  ,[Is_Deleted]
	    )
   VALUES
	    (
		@Name,
		@Unit_Id,
		@ItemCode,
		@ItemCategory_Id,
		@IndicatingUnitPrice,
		@imsCategoryId,
		@imsSubCategoryId,
		@SystemName,
		@Created_By,
		GETDATE(),
		@Created_By,
		GETDATE(),
		0
	    )
   SELECT
		SCOPE_IDENTITY() AS [Id]
END
GO

IF OBJECT_ID('[dbo].[sp_itemCategory_create]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_itemCategory_create]
END
GO
CREATE PROCEDURE [dbo].[sp_itemCategory_create]
@ParticularId					INT,
	@Name				NVARCHAR(256),
	@CreatedById					INT
AS
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [ItemCategory]
	    (
		[Particular_Id]
		   ,[Name]
		  ,[Created_By]
		  ,[Created_Date]
		  ,[Updated_By]
		  ,[Updated_Date]
		  ,[Is_Deleted]
	    )
   VALUES
	    (
		@ParticularId,
		@Name,
		@CreatedById,
		GETDATE(),
		@CreatedById,
		GETDATE(),
		0
	    )
   SELECT
		SCOPE_IDENTITY() AS [Id]
END
GO
IF OBJECT_ID('[dbo].[sp_approver_get_by_module]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_approver_get_by_module]
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_approver_get_by_module]
@moduleId int,
@requestNo nvarchar(50)
AS
BEGIN
    SET NOCOUNT ON;

    IF @moduleId = 1
	BEGIN
		
		SELECT 
			approve.[Estimate_Id] RequestId
			,approve.[User_Id] ApproverId
			,CONCAT(us.First_Name, ' ', us.Last_Name) ApproverFullName
			,dept.Name ApproverDepartment
			,dept.ID ApproverDepartmentId
			,approve.[Priority] ApproverPriority
			,approve.[Status] ApproverStatus
			,approve.RolePriority_Id ApproverRoleId
			,rolePr.Name ApproverRoleName
			,FORMAT (approve.PlanDate, 'MM/dd/yyyy') PlanDate
			,[RolePriority_Id]
		FROM [EstimateApprover] approve

		inner join [User] us
		on approve.User_Id = us.Id

		inner join Department dept
		on us.Department_Id = dept.ID

		inner join RolePriority rolePr
		on approve.RolePriority_Id = rolePr.ID

		where approve.[Estimate_Id] = (SELECT TOP 1 ID FROM Estimation WHERE UniqueIdentifier = @requestNo)
		and approve.Is_Deleted = 0 
		and us.Is_Deleted = 0

		order by approve.Priority desc
	END
    IF @moduleId = 2
	BEGIN
		
		SELECT 
			approve.[SettlementId] RequestId
			,approve.[User_Id] ApproverId
			,CONCAT(us.First_Name, ' ', us.Last_Name) ApproverFullName
			,dept.Name ApproverDepartment
			,dept.ID ApproverDepartmentId
			,approve.[Priority] ApproverPriority
			,approve.[Status] ApproverStatus
			,approve.RolePriority_Id ApproverRoleId
			,rolePr.Name ApproverRoleName
			,FORMAT (approve.PlanDate, 'MM/dd/yyyy') PlanDate
			,[RolePriority_Id]
		FROM [SettlementApprover] approve

		inner join [User] us
		on approve.User_Id = us.Id

		inner join Department dept
		on us.Department_Id = dept.ID

		inner join RolePriority rolePr
		on approve.RolePriority_Id = rolePr.ID

		where approve.[SettlementId] = (SELECT TOP 1 Id FROM Settlement WHERE RequestNo = @requestNo)
		and approve.Is_Deleted = 0 
		and us.Is_Deleted = 0

		order by approve.Priority desc
	END
END
GO
IF OBJECT_ID('[dbo].[sp_Update_Request_Status]') IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_Update_Request_Status]
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Update_Request_Status]
	@ModuleId								INT,
	@StatusId								INT,
	@RequestNo								VARCHAR(50),
	@P_Key									INT OUTPUT
AS
BEGIN

	IF @ModuleId = 1
	BEGIN
		UPDATE Estimation SET Status = @StatusId WHERE UniqueIdentifier = @RequestNo
	END
	IF @ModuleId = 2
	BEGIN
		UPDATE Settlement SET Status = @StatusId WHERE RequestNo = @RequestNo
	END

	SELECT @P_Key = 1;

	SELECT @P_Key AS [Id]
END
GO

IF OBJECT_ID('[dbo].[sp_Approver_Modification]') IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_Approver_Modification]
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Approver_Modification]
	@ModuleId								INT,
	@RequestNo								VARCHAR(50),
	@ApproverList dbo.ApproverItemsUDT		READONLY,
	@P_Key									INT OUTPUT
AS
BEGIN

	DECLARE @requestId INT;

	IF @ModuleId = 1
	BEGIN
		SELECT @requestId = ID FROM Estimation WHERE UniqueIdentifier = @RequestNo

		MERGE EstimateApprover AS trg
		USING @ApproverList AS src
		  ON src.ApproverId = trg.User_Id AND trg.Estimate_Id = @requestId
		 WHEN MATCHED THEN
		   UPDATE SET Priority = src.PriorityId, Status = src.StatusId
		 WHEN NOT MATCHED BY TARGET THEN
		   INSERT (Estimate_Id,User_Id,Priority,Status,RolePriority_Id,Created_By,Created_Date,Updated_By,Updated_Date,Is_Deleted,PlanDate)
		   VALUES (@requestId, src.ApproverId, src.PriorityId, src.StatusId, src.RolePriority_Id, 1, GETDATE(), 1, GETDATE(), 0 , src.PlanDate);

	END
	IF @ModuleId = 2
	BEGIN
		SELECT @requestId = ID FROM Settlement WHERE RequestNo = @RequestNo

		MERGE SettlementApprover AS trg
		USING @ApproverList AS src
		  ON src.ApproverId = trg.User_Id AND trg.SettlementId = @requestId
		 WHEN MATCHED THEN
		   UPDATE SET Priority = src.PriorityId, Status = src.StatusId
		 WHEN NOT MATCHED BY TARGET THEN
		   INSERT (SettlementId,User_Id,Priority,Status,RolePriority_Id,Created_By,Created_Date,Updated_By,Updated_Date,Is_Deleted,PlanDate)
		   VALUES (@requestId, src.ApproverId, src.PriorityId, src.StatusId, src.RolePriority_Id, 1, GETDATE(), 1, GETDATE(), 0 , src.PlanDate);

	END
	SELECT @P_Key = 1;

	SELECT @P_Key AS [Id]
END
GO
IF OBJECT_ID('[dbo].[sp_Update_ApproverRole]') IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_Update_ApproverRole]
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Update_ApproverRole]
	@ModuleId							INT,
	@RequestNo							VARCHAR(50),
	@ApproverId							INT,
	@RoleId								INT,
	@P_Key								INT OUTPUT
AS
BEGIN

	DECLARE @requestId INT;

	IF @ModuleId = 1
	BEGIN
		SELECT @requestId = ID FROM Estimation WHERE UniqueIdentifier = @RequestNo
		UPDATE EstimateApprover SET RolePriority_Id = @RoleId WHERE Estimate_Id = @requestId AND User_Id = @ApproverId
	END
	IF @ModuleId = 2
	BEGIN
		SELECT @requestId = ID FROM Settlement WHERE RequestNo = @RequestNo
		UPDATE SettlementApprover SET RolePriority_Id = @RoleId WHERE SettlementId = @requestId AND User_Id = @ApproverId
	END
	SELECT @P_Key = 1;

	SELECT @P_Key AS [Id]
END
GO
IF OBJECT_ID('[dbo].[sp_Update_User_Department]') IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_Update_User_Department]
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[sp_Update_User_Department]
	@UserId							INT,
	@DepartmentId					INT,
	@P_Key							INT OUTPUT
AS
BEGIN

		UPDATE [User] SET Department_Id = @DepartmentId WHERE Id = @UserId

	SELECT @P_Key AS [Id]
END
GO
IF OBJECT_ID('[dbo].[sp_particular_create]')IS NOT NULL
BEGIN
DROP PROC [dbo].[sp_particular_create]
END
GO
CREATE PROCEDURE [dbo].[sp_particular_create]
	@Name				NVARCHAR(256),
	@CreatedById					INT
AS
BEGIN
	SET NOCOUNT ON;

    INSERT INTO [Particular]
	    (
		   [Name]
		  ,[Created_By]
		  ,[Created_Date]
		  ,[Updated_By]
		  ,[Updated_Date]
		  ,[Is_Deleted]
	    )
   VALUES
	    (
		@Name,
		@CreatedById,
		GETDATE(),
		@CreatedById,
		GETDATE(),
		0
	    )
   SELECT
		SCOPE_IDENTITY() AS [Id]
END
GO