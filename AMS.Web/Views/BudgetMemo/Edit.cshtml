@model AMS.Models.CustomModels.EstimationInfoForMemo
@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
}
@using AMS.Models.DomainModels
@inject AMS.Services.Managers.Contracts.ISessionManager _sessionManager
@{
    UserEntity? user = await _sessionManager.GetUser();
}
<div class="hiddenElements">
    <input id="estimateId" type="hidden" value="@Model.EstimateId" />
    <input id="estimateIdProtected" type="hidden" value="@Model.EstimateIdProtected" />
</div>
<div class="hiddenElements">
    <input id="estimateReferId" type="hidden" value="@Model.EstimationReferenceId" />
</div>
<div class="hiddenElements">
    <input id="estimateMemoId" type="hidden" value="@Model.MemoId" />
</div>
<div class="container-fluid">
    <form id="form">
        @await Html.PartialAsync("_BudgetInfoPartial")
        @await Html.PartialAsync("_DepartmentWiseRunningSummaryPartial")
        @await Html.PartialAsync("_BudgetSettlementSummaryPartial")
        @await Html.PartialAsync("_MemoDetailsPartial")
        @await Html.PartialAsync("_AddApproverPartial")
        <div class="card border-secondary mb-4">
            <div class="card-header hideShow"><b>Approver List</b></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-bordered" id="TableAprroverList">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th scope="col">Approver</th>
                                <th scope="col">Approver Type</th>
                                <th scope="col">Expected Time</th>
                                <th scope="col">Status</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tApproverbody" style="text-align:left">
                            <tr>
                                <td>&nbsp;</td>
                                <td class="text-left">@Model.CreateorFullName</td>
                                <td class="text-left">Creator</td>
                                <td class="text-left"></td>
                                <td class="text-left"><span style='padding:2px 10px 2px 10px;border-radius: 25px;border: 2px solid gray;background-color:gray;color:white'>Created</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card border-secondary mb-4">
            <div class="card-header hideShow"><b>Approver Feedback List</b></div>
            <div class="card-body">

                <div class="container-fluid">
                    <span id="app_err-container"></span>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover table-bordered" id="TableAprroverFeedBackList">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th scope="col">Approver</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Feedback Date</th>
                                    <th scope="col">Feedback</th>
                                </tr>
                            </thead>
                            <tbody id="tApproverRemarksbody" style="text-align:left">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <br />
        <div class="container-fluid">
            <div class="form-group row" style="align-content:center">
                <div class="col-sm-5"></div>
                <div class="col-sm-7 ">
                    <button type="button" id="updateBudgeMemo" class="btn btn-outline-info text-decoration-none"><i class="fa fa-file"></i> Submit Memo</button>
                </div>
            </div>
        </div>
    </form>
</div>


@section Scripts{
    <script src="~/js/AjaxCall/Memo.js"></script>
    <script>
        $(document).ready(function() {
            var estimateId = $("#estimateId").val();
            var memoId = $("#estimateMemoId").val();
            loadUserList();
            formateCurrency();
            loadDepartmentWiseRunningSummary(estimateId);
            loadApprovers(memoId);
            loadEstimateApproverRemarkList(memoId);
            function loadApprovers(memoId) {
                $.ajax({
                    type: "GET",
                    url: "/BudgetMemo/LoadAllApproverByMemo?memoId=" + memoId,
                    data: "{}",
                    success: function(data) {
                        var approvers = data;
                        console.log(approvers);

                        var statusTag = "";
                        for (var i = 0; i < approvers.length; i++) {
                            var expectedDate = "";
                            if (approvers[i].approverRoleId == 1 || approvers[i].approverRoleId == 2) {
                                if (approvers[i].approverStatus == "2") {
                                    statusTag = "<span style='padding:2px 10px 2px 10px;border-radius: 25px;border: 2px solid royalblue;background-color:royalblue;color:white'>Pending</span>";
                                }
                                else if (approvers[i].approverStatus == "100") {
                                    statusTag = "<span style='padding:2px 10px 2px 10px;border-radius: 25px;border: 2px solid green;background-color:green;color:white'>Approved</span>";
                                }
                                else if (approvers[i].approverStatus == "-404") {
                                    statusTag = "<span style='padding:2px 10px 2px 10px;border-radius: 25px;border: 2px solid orangered;background-color:orangered;color:white'>Rollbacked</span>";
                                }
                                else if (approvers[i].approverStatus == "-500") {
                                    statusTag = "<span style='padding:2px 10px 2px 10px;border-radius: 25px;border: 2px solid red;background-color:red;color:white'>Rejected</span>";
                                }

                                var d = new Date(approvers[i].approverPlanDate);
                                expectedDate = d.toDateString();
                            }
                            $('#tApproverbody').append(
                                `<tr>
                                                        <td>&nbsp;</td>
                                                        <td class="approverName">` + approvers[i].approverFullName + ` / ` + approvers[i].approverDepartment + ` </td>
                                                        <td class="approverId" hidden>` + approvers[i].approverId + `</td>
                                                        <td class="approverPriority" hidden>` + approvers[i].approverPriority + `</td>
                                                        <td class="approverPriorityType" hidden>` + approvers[i].approverRoleId + `</td>
                                                        <td class="approverPriorityTypeText">` + approvers[i].approverRoleName + `</td>
                                                        <td class="approverDepartment" hidden>` + approvers[i].approverDepartment + `</td>
                                                        <td class="approverDepartmentId" hidden>` + approvers[i].approverDepartmentId + `</td>
                                                        <td class="">`+ expectedDate + `</td>
                                                        <td class="approverExpectedTime" hidden>`+ approvers[i].approverPlanDate + `</td>
                                                        <td>`+ statusTag + `</td>
                                                        <td class="text-center">
                                                            <button class="btn btn-danger remove" type="button"><i class="fa fa-trash" aria-hidden="true"></i></button>
                                                        </td>
                                                    </tr>`);
                        }
                    }
                });
            }
        });
    </script>
}

