@model IEnumerable<AMS.Models.ServiceModels.BudgetEstimate.EstimateEditVM>
@using AMS.Models.ServiceModels.BudgetEstimate
@using AMS.Models.DomainModels
@using AMS.Models.CustomModels
@using System.Globalization
@using AMS.Common.Helpers
@{
    ViewData["Title"] = "RunningBoard";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}
@inject AMS.Services.Managers.Contracts.ISessionManager _sessionManager
@{
    UserEntity? user = await _sessionManager.GetUser();
}
<style>
    .arrow {
        border: solid black;
        border-width: 0 3px 3px 0;
        display: inline-block;
        padding: 3px;
    }

    .right {
        transform: rotate(-45deg);
        -webkit-transform: rotate(-45deg);
</style>

<div class="card shadow mb-4">
    <div class="card-header col-md-12">
        <div class="row">
            <div class="col-md-3">
                <label> Running Following Status Board</label>
            </div>
            <div class="col-md-3">
                <select id="filterSelect" class="form-control">
                    <option value="All" selected>All</option>
                    <option value="Final">On Final Approval</option>
                    <option value="Rollbacked">Roll Backed</option>
                    <option value="Running">Running</option>
                </select>

            </div>
            <div class="col-md-2"> <label for="exampleFormControlInput1" class="form-label">Approver Parking</label></div>
            <div class="col-md-3">
               
                <input type="text" class="form-control" id="approverName" placeholder="Approver Name"> 
            </div>
            <div class="col-md-1">
                <a id="btnDownloadExcelReport" href="/ReportGenarator/RunningEstimateReport" class="btn btn-info float-right">
                    <span class="icon text-gray-100">
                        <i class="fas fa-download"></i>
                    </span>
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <table style="font-weight: 400;" class="table table-bordered table-striped" id="dataTable" width="100%" cellspacing="0" role="grid" aria-describedby="dataTable_info">
            <thead class="thead-dark">
                <tr>
                    <th>Budget Detail</th>
                    <th>Creation Details</th>
                    <th>Status</th>
                    <th>Work Flow</th>
                    <th hidden>On Final Approval</th>
                    <th hidden>Current Approver Name</th>
                    <th>View</th>
                </tr>
            </thead>
            <tbody class="text-center">
                @foreach (var item in Model)
                {
                    //value.ToString("C3", CultureInfo.CreateSpecificCulture("en-BD"))
                    <tr class="text-left">
                        <td class="text-left">
                            <div class="card" @*style="width: 18rem;"*@>
                                <div class="card-header">
                                    <b>Identity : <mark> @item.EstimationIdentity </mark> </b>
                                </div>
                                <div class="card-header">
                                    <b>Budget :</b> @item.Subject
                                </div>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item"><b>Start Date :</b> @item.PlanStartDate.ToString("d")</li>
                                    <li class="list-group-item"><b>End Date :</b> @item.PlanEndDate.ToString("d")</li>
                                    <li class="list-group-item"><b>Total Budget Price :</b> @item.TotalPrice.ToString()  @Utility.CurrencyTypeConvertToStringFormat(item.CurrencyType) </li>
                                </ul>
                            </div>
                        </td>
                        <td>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><b>Creator Name:</b> @item.CreatedBy.First_Name @item.CreatedBy.Last_Name</li>
                                <li class="list-group-item"><b>Creator Username:</b> @item.CreatedBy.Username</li>
                                <li class="list-group-item"><b>Creation Date :</b> @item.CreatedTime.ToString("f")</li>
                            </ul>
                        </td>
                        <td>
                            <div style="margin-top : 3px">
                                @if (item.Status == BaseEntity.EntityStatus.Pending.ToString())
                                {
                                    <button type="button" class="btn btn-info">Running</button>
                                }
                                else if (item.Status == BaseEntity.EntityStatus.CR.ToString())
                                {
                                    <button type="button" class="btn btn-warning">Rollbacked</button>
                                }
                                else if (item.Status == BaseEntity.EntityStatus.Draft.ToString())
                                {
                                    <button type="button" class="btn btn-light">Draft</button>
                                }
                            </div>
                        </td>
                        <td class="text-left">
                            @{
                                var lastItem = item.EstimateApproverList.Last();
                            }

                            @foreach (EstimateApproverVM approverVM in item.EstimateApproverList.OrderByDescending(x => x.Priority).ToList())
                            {
                                if (approverVM.Status == BaseEntity.EntityStatus.Completed.ToString())
                                {
                                    <div style="padding: 5px;display: inline-block">
                                        <button type="button" class="btn btn-success" data-toggle="tooltip" title="@approverVM.UserFullName Response:@approverVM.ResponseTime">
                                            @approverVM.UserName
                                        </button>
                                    </div>
                                }
                                else if (approverVM.Status == BaseEntity.EntityStatus.Pending.ToString())
                                {
                                    if (approverVM.Priority == item.NextPriority && item.Status == BaseEntity.EntityStatus.Pending.ToString())
                                    {
                                        <div style="padding: 5px;display: inline-block">
                                            <button type="button" class="btn btn-info" data-toggle="tooltip" title="@approverVM.UserFullName">
                                                @approverVM.UserName
                                            </button>
                                        </div>
                                        
                                    }
                                    else
                                    {
                                        <div style="padding: 5px;display: inline-block">
                                            <button type="button" class="btn btn-secondary" data-toggle="tooltip" title="@approverVM.UserFullName">
                                                @approverVM.UserName
                                            </button>
                                        </div>
                                        
                                    }
                                }
                                else if (approverVM.Status == BaseEntity.EntityStatus.CR.ToString())
                                {
                                    <div style="padding: 5px;display: inline-block">
                                        <button type="button" class="btn btn-warning" data-toggle="tooltip" title="@approverVM.UserFullName">
                                            @approverVM.UserName
                                        </button>
                                    </div>
                                    
                                }
                                if (!approverVM.Equals(lastItem))
                                {
                                    <i class="fa fa-arrow-circle-right"></i>
                                }
                            }
                        </td>
                        <td hidden>@item.IsInFinalApproval</td>
                        <td hidden>@{
                                       var lastItems = item.EstimateApproverList.Last();
                                   }
                            @foreach (EstimateApproverVM approverVM in item.EstimateApproverList.OrderByDescending(x => x.Priority).ToList())
                            {
                                 if (approverVM.Status == BaseEntity.EntityStatus.Pending.ToString())
                                {
                                    if (approverVM.Priority == item.NextPriority && item.Status == BaseEntity.EntityStatus.Pending.ToString())
                                    {
                                        
                                                @approverVM.UserName
                                          

                                    }
                                    /*else
                                    {
                                        <div style="padding: 5px;display: inline-block">
                                            <button type="button" class="btn btn-secondary" data-toggle="tooltip" title="@approverVM.UserFullName">
                                                @approverVM.UserName
                                            </button>
                                        </div>

                                    }*/
                                }
                               
                            }
                            </td>
                        <td >
                            <a class="form-control btn btn-light float-right" style="margin-top : 3px" href="/BudgetEstimation/ViewEstimation?id=@item.EncryptedId">
                                <i class='fas fa-eye' data-toggle='tooltip' data-placement='left' title='View'></i>
                            </a>  
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts{
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap4.min.js "></script>
    <script>
        $(document).ready(function () {
            var table = $('#dataTable').DataTable({
                "ordering": false
            });

            $("select").each(function () {
                $(this).val($(this).find('option[selected]').val());
            });

            $('#filterSelect').on('change', function () {
                table.columns().search("");
                var selectedStatusFilterValue = $(this).val();
                console.log(selectedStatusFilterValue);
                if (selectedStatusFilterValue == 'All') {
                    table.column(2).search("Rollbacked|Running", true, false).draw();
                    

                } else {
                    if (selectedStatusFilterValue == 'Final') {
                      
                         table.columns(4).search(1).columns(2).search("Running").draw();
                    } else {
                        console.log("trigger");
                        table.columns(2).search(this.value).draw();
                    }
                }
            });




            $('#approverName').on("change paste keyup", function () {
               
    
                table.columns().search("");
               var approverName = $(this).val();

                table.column(5).search(approverName, true, false)
                   .draw();


                
            });
            


        });
    </script>
}